<% ADDRESS_FIELDS.each do |field| %>
<% if field == "country" %>
<%= address_field(address_form, :country, address_name) do %>
<%= address_form.label :country_id, t(field, :scope => [:activerecord, :attributes, "spree/address"]) %><span class="req">*</span>
<br />
<span id="<%= address_name[0] %>country"><%= address_form.collection_select :country_id, available_countries, :id, :name, {}, {:class => 'required'} %></span>
<% end %>
<% elsif field == "state" && Spree::Config[:address_requires_state] %>
<span id="<%= address_name[0] %>state"><%= address_field(address_form, :state, address_name) { address_state(address_form, address.country) } %></span>
<% else %>
<% next if field == "company" && !Spree::Config[:company] %>
<%= address_field(address_form, field.to_sym, address_name) %>
<% end %>
<% end %>
<% if Spree::Config["alternative_#{address_name[0] == 'b' ? 'billing' : 'shipping'}_phone"] %>
<%= address_field(address_form, :alternative_phone, address_name) %>
<% end %>

<% content_for :head do %>
<%= javascript_include_tag states_url %>
<%= javascript_tag do -%>
$(document).ready(function(){
$('span#<%= address_name[0] %>country select').change(function() { update_states('<%= address_name[0] %>'); });
});

var update_states = function(region) {
var country = $('span#' + region + 'country select').val();
var states = state_mapper[country];

var state_select = $('span#' + region + 'state p select');
var state_input = $('span#' + region + 'state p input');

if(states) {
state_select.html('');
var states_with_blank = [["",""]].concat(states);
$.each(states_with_blank, function(pos,id_nm) {
var opt = $(document.createElement('option'))
.attr('value', id_nm[0])
.html(id_nm[1]);
state_select.append(opt);
});
state_select.prop("disabled", false).show();
state_input.hide().prop("disabled", true);

} else {
state_input.prop("disabled", false).show();
state_select.hide().prop("disabled", true);
}

};
<% end -%>
<% end %>